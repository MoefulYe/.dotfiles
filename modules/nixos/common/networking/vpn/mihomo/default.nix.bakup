{
  config,
  lib,
  pkgs,
  ...
}:
{
  options.networking.mihomo = {
    tproxyPort = lib.mkOption {
      type = lib.types.int;
      default = 7895;
    };
    mihomoMark = lib.mkOption {
      type = lib.types.int;
      default = 666;
    };
  };
  config = {
    services.mihomo = {
      enable = true;
      tunMode = true;
      configFile = config.sops.templates."mihomo.yaml".path;
      webui = pkgs.metacubexd;
    };
    sops.secrets = {
      MIHOMO_IKUUU = { };
      MIHOMO_LEITING = { };
      MIHOMO_MOJIE = { };
      MIHOMO_SECRET = { };
    };
    sops.templates."mihomo.yaml".content = ''
      mode: rule
      ipv6: false
      log-level: debug
      allow-lan: true
      tproxy-port: ${toString config.networking.mihomo.tproxyPort}
      routing-mark: ${toString config.networking.mihomo.mihomoMark}
      unified-delay: true
      tcp-concurrent: true
      external-controller: :9090
      secret: ${config.sops.placeholder.MIHOMO_SECRET}
      geodata-mode: true
      geox-url:
        geoip: "https://hub.gitmirror.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geoip.dat"
        geosite: "https://hub.gitmirror.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/geosite.dat"
        mmdb: "https://hub.gitmirror.com/https://github.com/MetaCubeX/meta-rules-dat/releases/download/latest/country.mmdb"
      find-process-mode: strict
      # set it to bigger number to reduce the power consumption issue on mobile devices
      # https://github.com/vernesong/OpenClash/issues/2614
      keep-alive-interval: 1800
      # å…¨å±€å®¢æˆ·ç«¯æŒ‡çº¹
      global-client-fingerprint: random # éšæœºæŒ‡çº¹
      # ç¼“å­˜
      profile:
        store-selected: true
        store-fake-ip: true
        tracing: false  # ç¦ç”¨è¿½è¸ªåŠŸèƒ½ï¼Œå¯èƒ½å‡å°‘å¯¹ç”¨æˆ·ä¿¡æ¯çš„ä¾èµ–

      proxy-providers:
        mojie:
          type: http
          interval: 36000
          health-check:
            enable: true
            url: https://cp.cloudflare.com
            interval: 300
            timeout: 1000
            tolerance: 100
          path: ./proxy_provider/mojie.yaml
          url: "${config.sops.placeholder.MIHOMO_MOJIE}"
          override:
            udp: true
        leiting:
          type: http
          interval: 36000
          health-check:
            enable: true
            url: https://cp.cloudflare.com
            interval: 300
            timeout: 1000
            tolerance: 100
          path: ./proxy_provider/leiting.yaml
          url: "${config.sops.placeholder.MIHOMO_LEITING}"
          override:
            udp: true
        ikuuu:
          type: http
          interval: 36000
          health-check:
            enable: true
            url: https://cp.cloudflare.com
            interval: 300
            timeout: 1000
            tolerance: 100
          path: ./proxy_provider/ikuuu.yaml
          url: "${config.sops.placeholder.MIHOMO_IKUUU}"
          override:
            udp: true
        # local-subscription:
          # path: ./proxy_provider/local.yaml

      rule-providers:
        # anti-AD, can remove if had mistake
        # https://github.com/privacy-protection-tools/anti-AD
        anti-AD:
          type: http
          behavior: domain
          format: yaml
          path: ./rule_provider/anti-AD.yaml
          url: "https://raw.githubusercontent.com/privacy-protection-tools/anti-AD/master/anti-ad-clash.yaml?"
          interval: 6000
        anti-AD-white:
          type: http
          behavior: domain
          format: yaml
          path: ./rule_provider/anti-AD-white.yaml
          url: "https://raw.githubusercontent.com/privacy-protection-tools/dead-horse/master/anti-ad-white-for-clash.yaml?"
          interval: 6000

      # åŸŸåå—…æ¢
      sniffer:
        enable: true
        sniff:
          TLS:
            ports: [443, 8443]
          HTTP:
            ports: [80, 8080-8880]
            override-destination: true

      proxies:
        # - name: "WARP"
        #   type: wireguard
        #   server: engage.cloudflareclient.com
        #   port: 2408
        #   ip: "172.16.0.2/32"
        #   ipv6: "2606::1/128"        # è‡ªè¡Œæ›¿æ¢
        #   private-key: "private-key" # è‡ªè¡Œæ›¿æ¢
        #   public-key: "public-key"   # è‡ªè¡Œæ›¿æ¢
        #   udp: true
        #   reserved: "abba"           # è‡ªè¡Œæ›¿æ¢
        #   mtu: 1280
        #   dialer-proxy: "WARPå‰ç½®"
        #   remote-dns-resolve: true
        #   dns:
        #     - https://dns.cloudflare.com/dns-query

      proxy-groups:
        # ä½¿ç”¨ WARP çš„ç”¨æˆ·éœ€è¦æ‰‹åŠ¨åœ¨ä¸‹æ–¹çš„ proxies å­—æ®µå†…æ·»åŠ  WARP
        # ä¾‹å¦‚ [WARP, all, auto-fast, hongkong, taiwan, japan, singapore, USA, other-region, DIRECT],
        - name: auto-fast
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          tolerance: 2
        - name: manual
          type: select
          proxies:
          - all
          - auto-fast
          - hongkong
          - taiwan
          - japan
          - singapore
          - USA
          - other-region
          - DIRECT
        - name: dns
          type: select
          proxies:
          - auto-fast
          - manual
          - hongkong
          - taiwan
          - japan
          - singapore
          - USA
          - other-region
          - all
          - DIRECT
        # WARP é…ç½®é“¾å¼å‡ºç«™
        # - name: WARPå‰ç½®
          # type: select
          # proxies:
          # - auto-fast
          # - select
          # - hongkong
          # - taiwan
          # - japan
          # - singapore
          # - USA
          # - other-region
          # - all
          # - DIRECT
          # exclude-type: "wireguard"

        - name: ad-block
          type: select
          proxies:
          - REJECT
          - DIRECT
          - manual

        - name: AI
          type: url-test
          proxies:
          - taiwan
          - singapore
          - japan
          - USA
          - france
          - germany
          - korea
          - canada
          - germany
          - ireland
          - SA
          - netherlands
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "S1|S2"
        - name: steam
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "D1"
        - name: netflix
          type: url-test
          proxies:
          - taiwan
          - singapore
          - japan
          - USA
          use:
          - mojie
          - leiting
          - ikuuu
        - name: video
          type: url-test
          proxies:
          - hongkong
          - netflix
          - taiwan
          - singapore
          - japan
          - USA
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "US|TW|SG|JA|HK|D1"
        - name: universal
          type: select
          proxies:
          - auto-fast
          - manual
          - hongkong
          - taiwan
          - japan
          - singapore
          - USA
          - other-region
          - all
          - DIRECT
        - name: local
          type: select
          proxies:
          - DIRECT
          - manual
          - hongkong
          - taiwan
          - japan
          - singapore
          - USA
          - korea
          - canada
          - germany
          - russia
          - ireland
          - SA
          - netherlands
          - france
          - other-region
          - all
          - auto-fast

        # continent
        - name: asia
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)äºš|asia"

        # region
        - name: hongkong
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)æ¸¯|hk|hongkong|hong kong"
        - name: taiwan
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)å°|tw|taiwan"
        - name: japan
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)japan|jp|japan"
        - name: USA
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)ç¾|unitedstates|united states"
        - name: UK
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)è‹±|uk|unitedkingdom|united kingdom"
        - name: korea
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)éŸ©|korea"
        - name: canada
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)åŠ |canada"
        - name: germany
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)å¾·|ge|germany"
        - name: russia
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)ä¿„|russia"
        - name: ireland
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)çˆ±|ireland"
        - name: SA
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)é|sa|south africa"
        - name: netherlands
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)è·|cl|netherlands"
        - name: france
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)æ³•|france"
        - name: singapore
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)(æ–°|sg|singapore)"
        - name: other-region
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu
          filter: "(?i)^(?!.*(?:ğŸ‡­ğŸ‡°|ğŸ‡¯ğŸ‡µ|ğŸ‡ºğŸ‡¸|ğŸ‡¸ğŸ‡¬|ğŸ‡¨ğŸ‡³|æ¸¯|hk|hongkong|å°|tw|taiwan|æ—¥|jp|japan|æ–°|sg|singapore|ç¾|us|unitedstates|è‹±|uk|unitedkingdom)).*"
        - name: all
          type: url-test
          use:
          - mojie
          - leiting
          - ikuuu


      rules:
        - GEOSITE,private,DIRECT,no-resolve
        - GEOIP,private,DIRECT,no-resolve
        # è‹¥éœ€ç¦ç”¨ QUIC è¯·å–æ¶ˆæ³¨é‡Š QUIC ä¸¤æ¡è§„åˆ™
        # é˜²æ­¢ YouTube ç­‰ä½¿ç”¨ QUIC å¯¼è‡´é€Ÿåº¦ä¸ä½³, ç¦ç”¨ 443 ç«¯å£ UDP æµé‡ï¼ˆä¸åŒ…æ‹¬å›½å†…ï¼‰
      # - AND,(AND,(DST-PORT,443),(NETWORK,UDP)),(NOT,((GEOSITE,cn))),REJECT # quic
        - AND,((RULE-SET,anti-AD),(NOT,((RULE-SET,anti-AD-white)))),ad-block # æ„Ÿè°¢ Telegram @nextyahooquery æä¾›çš„å»ºè®®
      # - GEOSITE,biliintl,video
      # - GEOSITE,bilibili,video

        - GEOSITE,openai,AI
        - GEOSITE,anthropic,AI
        - GEOSITE,x,AI
        - GEOSITE,xai,AI
        - DOMAIN-SUFFIX,claude.ai,AI
        - DOMAIN-SUFFIX,claudeusercontent.com,AI
        - DOMAIN-SUFFIX,reddit.com,hongkong
        - GEOSITE,apple,universal
        - GEOSITE,apple-cn,universal
        - GEOSITE,ehentai,universal
        - GEOSITE,github,universal
        - GEOSITE,twitter,universal
        - GEOSITE,youtube,universal
        - GEOSITE,google,universal
        - GEOSITE,google-cn,universal # Google CN ä¸èµ°ä»£ç†ä¼šå¯¼è‡´hongkongç­‰åœ°åŒºèŠ‚ç‚¹ Play Store å¼‚å¸¸
        - GEOSITE,telegram,universal
        - GEOSITE,netflix,netflix
        - GEOSITE,bahamut,universal
        - GEOSITE,spotify,universal
        - GEOSITE,pixiv,universal
        - GEOSITE,steam@cn,DIRECT
        - GEOSITE,steam,steam
        - GEOSITE,onedrive,universal
        - GEOSITE,microsoft,universal
        - GEOSITE,geolocation-!cn,universal
      # - AND,(AND,(DST-PORT,443),(NETWORK,UDP)),(NOT,((GEOIP,CN))),REJECT # quic
        - GEOIP,google,universal
        - GEOIP,netflix,netflix
        - GEOIP,telegram,universal
        - GEOIP,twitter,universal
        - GEOSITE,CN,local
        - GEOIP,CN,local
        - MATCH,universal
    '';
  };
}
